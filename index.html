<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Coach Mike | AI Interview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --primary: #007AFF; --bg: #F2F2F7; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .bubble { animation: slideIn 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Animation de Respiration (Si image statique - Fallback) */
        .breathing { animation: breathe 3s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        
        /* Animation Talking (Si image statique - Fallback) */
        .talking-img { animation: talk-bounce 0.2s infinite alternate; }
        @keyframes talk-bounce { from { transform: scale(1); } to { transform: scale(1.01) translateY(-1px); } }

        .blur-reveal { filter: blur(8px); cursor: pointer; transition: all 0.4s ease; user-select: none; background: rgba(0,0,0,0.05); color: transparent; }
        .blur-reveal:hover { filter: blur(4px); }
        .blur-reveal.revealed { filter: blur(0); cursor: text; user-select: text; background: transparent; color: inherit; }
    </style>
</head>
<body class="text-slate-800">

    <div id="setup-screen" class="fixed inset-0 bg-white z-50 flex flex-col p-6 transition-transform duration-500 ease-in-out">
        <div class="flex-1 flex flex-col justify-center max-w-md mx-auto w-full">
            <div class="mb-8 text-center">
                
                <div class="w-24 h-24 rounded-full mx-auto mb-4 shadow-sm border-4 border-white overflow-hidden">
                    <img src="coach_static.png" 
                         class="w-full h-full object-cover breathing" 
                         alt="Coach Mike Static Avatar">
                </div>
                
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Coach Mike.</h1>
                <p class="text-slate-500">Professional Interview Prep</p>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold uppercase text-slate-400 tracking-wider ml-1">Candidate Name</label>
                    <input id="inp-name" type="text" class="w-full p-4 bg-slate-50 rounded-xl font-semibold outline-none focus:ring-2 ring-blue-500 border border-slate-200 transition-all" value="Alex">
                </div>
                <div>
                    <label class="text-xs font-bold uppercase text-slate-400 tracking-wider ml-1">Target Role</label>
                    <input id="inp-job" type="text" class="w-full p-4 bg-slate-50 rounded-xl font-semibold outline-none focus:ring-2 ring-blue-500 border border-slate-200 transition-all" value="Product Manager">
                </div>
                <div>
                    <label class="text-xs font-bold uppercase text-slate-400 tracking-wider ml-1">Company Context</label>
                    <input id="inp-company" type="text" class="w-full p-4 bg-slate-50 rounded-xl font-semibold outline-none focus:ring-2 ring-blue-500 border border-slate-200 transition-all" value="Tech Startup">
                </div>
            </div>

            <button onclick="startSession()" class="mt-8 w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg shadow-xl hover:bg-blue-700 transition-all transform active:scale-95 duration-100 flex items-center justify-center gap-2">
                Start Interview <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <header class="bg-white/80 backdrop-blur-md border-b p-3 flex flex-col items-center z-10 sticky top-0 shadow-sm">
        <div class="relative w-24 h-24 mb-1 group">
            <div class="w-full h-full rounded-full overflow-hidden border-4 border-white shadow-lg relative bg-slate-200">
                
                <video id="vid-idle" src="idle.mp4" loop muted playsinline class="absolute inset-0 w-full h-full object-cover hidden"></video>
                
                <video id="vid-talk" src="talk.mp4" loop muted playsinline class="absolute inset-0 w-full h-full object-cover hidden"></video>
                
                <img id="avatar-img" src="coach_static.png" 
                     class="w-full h-full object-cover breathing"
                     alt="Coach Mike">
            </div>
            
            <div id="audio-indicator" class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full border-2 border-white flex items-center justify-center opacity-0 transition-opacity">
                <i class="fas fa-volume-up text-white text-[10px]"></i>
            </div>
        </div>
        
        <div class="text-center mt-1">
            <h2 class="font-bold text-sm text-slate-800">Coach Mike</h2>
            <p id="role-display" class="text-[10px] uppercase font-bold text-blue-600 tracking-widest">AI Recruiter</p>
        </div>
    </header>

    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-6 pb-40 bg-slate-50">
        </main>

    <footer class="bg-white border-t p-6 pb-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-20 relative">
        <div class="flex flex-col items-center">
            <p id="status-txt" class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 h-4 transition-all">Tap mic to answer</p>
            
            <button id="mic-btn" class="w-20 h-20 rounded-full bg-blue-600 text-white text-3xl shadow-blue-200 shadow-2xl flex items-center justify-center transition-all active:scale-90 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:grayscale" disabled>
                <div id="btn-icon"><i class="fas fa-microphone"></i></div>
                <div id="btn-loader" class="hidden w-8 h-8 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
            </button>
        </div>
    </footer>

    <script>
        // CORRECTION API_URL (L. 254) : Utilisation du protocole HTTPS comme source de v√©rit√©
        const API_URL = window.location.protocol === 'https:' 
            ? window.location.origin 
            : "http://127.0.0.1:5000";
        let sessionId = localStorage.getItem('coach_sess') || 'sess_' + Date.now();
        localStorage.setItem('coach_sess', sessionId);
        
        let mediaRecorder;
        let audioChunks = [];

        // ... (Le reste du script JavaScript est inchang√©) ...

        // --- GESTION AVATAR (VIDEO SWAP) ---
        const vidIdle = document.getElementById('vid-idle');
        const vidTalk = document.getElementById('vid-talk');
        const imgAvatar = document.getElementById('avatar-img');
        const audioIndicator = document.getElementById('audio-indicator');

        function initAvatar() {
            // Tentative de lancement de la vid√©o Idle
            // On v√©rifie si la vid√©o peut √™tre jou√©e
            vidIdle.play().then(() => {
                console.log("Avatar Vid√©o Activ√©");
                imgAvatar.style.display = 'none';
                vidIdle.classList.remove('hidden');
            }).catch(e => {
                console.warn("Autoplay vid√©o bloqu√© ou fichier manquant. Fallback sur l'image.", e);
                // Si √ßa √©choue (fichier manquant ou blocage navigateur), on garde l'image
            });
        }
        
        function setAvatarState(isTalking) {
            audioIndicator.style.opacity = isTalking ? '1' : '0';
            
            // Si le mode vid√©o est actif (vidIdle est visible)
            if (!vidIdle.classList.contains('hidden') || !vidTalk.classList.contains('hidden')) {
                if (isTalking) {
                    vidIdle.classList.add('hidden');
                    vidTalk.classList.remove('hidden');
                    vidTalk.play();
                } else {
                    vidTalk.classList.add('hidden');
                    vidIdle.classList.remove('hidden');
                    vidIdle.play();
                }
            } else {
                // Mode Image Fallback
                if (isTalking) {
                    imgAvatar.classList.remove('breathing');
                    imgAvatar.classList.add('talking-img');
                } else {
                    imgAvatar.classList.remove('talking-img');
                    imgAvatar.classList.add('breathing');
                }
            }
        }

        // --- LECTEUR AUDIO ---
        function playAudio(base64Audio) {
            if (!base64Audio) {
                console.warn("Aucun audio re√ßu du serveur.");
                return;
            }
            
            const audio = new Audio("data:audio/mp3;base64," + base64Audio);
            
            audio.onplay = () => setAvatarState(true);
            audio.onended = () => setAvatarState(false);
            audio.onerror = (e) => {
                console.error("Erreur lecture:", e);
                setAvatarState(false);
            };
            
            audio.play().catch(e => console.log("Autoplay audio bloqu√©:", e));
        }

        // --- UI MESSAGES ---
        function addMsg(role, text, feedback=null) {
            const box = document.getElementById('chat-box');
            const isCoach = role === 'coach';
            
            const div = document.createElement('div');
            div.className = `bubble flex flex-col ${isCoach ? 'items-start' : 'items-end'}`;
            
            let html = `
                <div class="px-5 py-4 rounded-2xl max-w-[90%] text-[15px] leading-relaxed shadow-sm 
                            ${isCoach ? 'bg-white text-slate-800 rounded-tl-none border border-slate-200' : 'bg-blue-600 text-white rounded-tr-none'}">
                    ${text}
                </div>`;

            if (feedback) {
                const scoreColor = feedback.score >= 8 ? 'bg-green-500' : (feedback.score >= 5 ? 'bg-orange-500' : 'bg-red-500');
                
                html += `
                <div class="mt-3 ml-1 w-[95%] bg-white p-5 rounded-xl border border-slate-200 shadow-md space-y-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full ${scoreColor}"></div>
                    
                    <div class="flex justify-between items-end border-b border-slate-100 pb-3">
                        <div>
                            <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Performance</span>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl font-bold text-slate-800">${feedback.score}</span>
                                <span class="text-sm text-slate-400 font-medium">/10</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 text-sm">
                        ${feedback.grammar && feedback.grammar.length > 2 ? `
                        <div class="flex gap-3">
                            <div class="mt-1 w-6 h-6 rounded-full bg-red-100 text-red-600 flex items-center justify-center shrink-0 text-xs"><i class="fas fa-times"></i></div>
                            <div>
                                <p class="text-xs font-bold text-red-500 uppercase mb-0.5">Correction</p>
                                <p class="text-slate-700 leading-snug">${feedback.grammar}</p>
                            </div>
                        </div>` : ''}
                        
                        <div class="flex gap-3">
                            <div class="mt-1 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0 text-xs"><i class="fas fa-lightbulb"></i></div>
                            <div>
                                <p class="text-xs font-bold text-blue-500 uppercase mb-0.5">Pro Tip</p>
                                <p class="text-slate-700 leading-snug">${feedback.tip}</p>
                            </div>
                        </div>
                    </div>

                    <div class="pt-3 mt-2 border-t border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fas fa-star text-yellow-400"></i> Native Speaker Version
                        </p>
                        <div class="relative group cursor-pointer" onclick="this.querySelector('.blur-reveal').classList.add('revealed');">
                            <div class="blur-reveal p-3 bg-slate-50 rounded-lg text-slate-800 italic text-sm leading-relaxed border border-slate-100">
                                "${feedback.better}"
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            div.innerHTML = html;
            box.appendChild(div);
            requestAnimationFrame(() => box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' }));
        }

        // --- LOGIQUE APP ---
        async function startSession() {
            const name = document.getElementById('inp-name').value;
            const job = document.getElementById('inp-job').value;
            const company = document.getElementById('inp-company').value;
            
            document.getElementById('setup-screen').style.transform = 'translateY(-100%)';
            document.getElementById('role-display').innerText = `Interviewing for ${job}`;
            
            // Tentative d'activation de l'avatar vid√©o
            initAvatar();

            try {
                const res = await fetch(`${API_URL}/start_chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id: sessionId, candidate_name: name, job_title: job, company_type: company })
                });
                const data = await res.json();
                
                addMsg('coach', data.coach_response_text);
                
                if (data.audio_base64) {
                    playAudio(data.audio_base64);
                }
                
                initMic();
            } catch (e) {
                alert("Erreur Serveur: " + e);
                document.getElementById('setup-screen').style.transform = 'translateY(0)';
            }
        }

        async function initMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = sendAudio;
                
                const btn = document.getElementById('mic-btn');
                btn.disabled = false;
                
                const startRec = (e) => {
                    e.preventDefault();
                    audioChunks = [];
                    mediaRecorder.start();
                    btn.classList.add('scale-110', 'bg-red-500');
                    btn.classList.remove('bg-blue-600');
                    document.getElementById('status-txt').innerText = "Listening...";
                    document.getElementById('status-txt').classList.add('text-red-500');
                };

                const stopRec = (e) => {
                    e.preventDefault();
                    if (mediaRecorder.state === 'recording') mediaRecorder.stop();
                    btn.classList.remove('scale-110', 'bg-red-500');
                    btn.classList.add('bg-blue-600');
                    document.getElementById('status-txt').classList.remove('text-red-500');
                };

                btn.addEventListener('mousedown', startRec);
                btn.addEventListener('touchstart', startRec);
                btn.addEventListener('mouseup', stopRec);
                btn.addEventListener('touchend', stopRec);
                btn.addEventListener('mouseleave', stopRec);

            } catch (e) {
                document.getElementById('status-txt').innerText = "Mic Blocked üö´";
                alert("Microphone acc√®s refus√©.");
            }
        }

        async function sendAudio() {
            await new Promise(r => setTimeout(r, 200));
            if (audioChunks.length === 0) return;

            const btnIcon = document.getElementById('btn-icon');
            const loader = document.getElementById('btn-loader');
            const status = document.getElementById('status-txt');
            
            btnIcon.classList.add('hidden');
            loader.classList.remove('hidden');
            status.innerText = "Coach is thinking...";

            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const fd = new FormData();
            fd.append('audio', blob);
            fd.append('session_id', sessionId);

            try {
                const res = await fetch(`${API_URL}/analyze`, { method: 'POST', body: fd });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                addMsg('user', data.transcription_user);
                
                setTimeout(() => {
                    addMsg('coach', data.coach_response_text, {
                        score: data.score_pronunciation,
                        grammar: data.feedback_grammar,
                        tip: data.next_step_advice,
                        better: data.better_response_example
                    });
                    
                    if (data.audio_base64) {
                        playAudio(data.audio_base64);
                    }
                    
                }, 600);
                
            } catch (e) {
                console.error(e);
                status.innerText = "Error";
                addMsg('coach', `‚ö†Ô∏è Erreur: ${e.message}`);
            } finally {
                btnIcon.classList.remove('hidden');
                loader.classList.add('hidden');
                status.innerText = "Hold to Answer";
            }
        }
    </script>
</body>
</html>