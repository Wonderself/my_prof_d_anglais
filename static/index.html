<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JOB ITV SIMULATOR</title>
    <link rel="icon" href="/static/fav.png" type="image/png">  <!-- FIX: Chemin absolu pour Render -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="/static/manifest.json">  <!-- FIX: Chemin absolu -->
    <meta name="theme-color" content="#007AFF">
    <link rel="apple-touch-icon" href="/static/icon-192.png">  <!-- FIX: Chemin -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://www.paypal.com/sdk/js?client-id=AVaXhjiQjRN4YKxQnkh1jBWfgWDNjA23YLd3SAUGPBDlDyjOeswmF1D0n0LnyniKbLa_HkZGB9vXAHuv&currency=EUR"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --primary: #007AFF; --bg: #F2F2F7; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .bubble { animation: slideIn 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        .blur-reveal { filter: blur(8px); cursor: pointer; transition: all 0.4s ease; user-select: none; background: rgba(0,0,0,0.05); color: transparent; }
        .blur-reveal:hover { filter: blur(4px); }
        .blur-reveal.revealed { filter: blur(0); cursor: text; user-select: text; background: transparent; color: inherit; }
        #setup-screen-inner { max-height: 100dvh; overflow-y: auto; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader-screen" class="fixed inset-0 bg-slate-800 z-50 flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="animate-pulse text-white text-center">
            <div class="w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-sm font-semibold tracking-wider uppercase">ROBOT WAKING UP...</p>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center p-6 hidden">
        <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-slate-100 mb-6 shadow-xl bg-slate-200 relative">
             <video src="/static/idle.mp4" autoplay loop muted playsinline class="w-full h-full object-cover"></video>  <!-- FIX: Chemin absolu -->
        </div>
        <h1 class="text-2xl font-bold mb-2 tracking-tight text-center">JOB ITV SIMULATOR</h1>
        <p class="text-slate-500 mb-8 text-center max-w-xs text-sm">Master your English interviews with AI.</p>
        <a href="/login/google" class="flex items-center gap-3 bg-white border border-slate-300 text-slate-700 px-6 py-4 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all w-full max-w-xs justify-center group">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 group-hover:scale-110 transition-transform">
            Continue with Google
        </a>
    </div>

    <!-- FIX: Redesign Landing - Style Apple : Minimal, Punchy, English Only -->
    <div id="payment-screen" class="fixed inset-0 bg-white z-40 flex flex-col p-6 overflow-y-auto hidden">
        <div class="w-full max-w-lg mx-auto py-8">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-black mb-4 text-slate-900 tracking-tight">JOB ITV SIMULATOR</h1>  <!-- Titre Impactant -->
                <p class="text-xl text-slate-600 font-semibold">AI-Powered Interview Mastery</p>
            </div>
            <div class="space-y-6 mb-8">  <!-- 3 Arguments Concis, Sans Fluff -->
                <div class="flex items-start gap-4 p-4 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mt-0.5 flex-shrink-0">1</div>
                    <div>
                        <h3 class="font-bold text-slate-900 mb-1">CV-Tailored Questions</h3>
                        <p class="text-sm text-slate-600">Upload your resume for personalized, real-world scenarios.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mt-0.5 flex-shrink-0">2</div>
                    <div>
                        <h3 class="font-bold text-slate-900 mb-1">Instant Feedback</h3>
                        <p class="text-sm text-slate-600">Pronunciation scores, grammar fixes, and pro tips in seconds.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm mt-0.5 flex-shrink-0">3</div>
                    <div>
                        <h3 class="font-bold text-slate-900 mb-1">Unlimited Practice</h3>
                        <p class="text-sm text-slate-600">3 months access. Speak confidently, land the job.</p>
                    </div>
                </div>
            </div>
            <div class="text-center mb-6">
                <p class="text-sm text-slate-500 mb-1">One-time unlock</p>
                <p class="text-4xl font-black text-slate-900">€9.99</p>
            </div>
            <div class="flex gap-2 w-full max-w-sm mx-auto mb-6">
                <input id="promo-code-input" type="text" placeholder="PROMO CODE" class="flex-1 p-3 border border-slate-300 rounded-xl font-semibold uppercase outline-none focus:ring-2 ring-blue-500 text-sm">
                <button onclick="applyPromoCode()" class="bg-blue-600 text-white p-3 rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors shrink-0">APPLY</button>
            </div>
            <p id="promo-message" class="text-center text-xs font-semibold mb-4 h-4"></p>
            <div id="paypal-button-container" class="w-full max-w-xs mx-auto min-h-[150px]"></div>
            <button onclick="window.location.href='/logout'" class="mt-6 text-xs text-slate-400 underline hover:text-slate-600 w-full text-center">Logout</button>
        </div>
    </div>

    <!-- Reste du HTML inchangé jusqu'au <script> -->
    <div id="setup-screen" class="fixed inset-0 bg-white z-30 flex flex-col hidden transition-transform duration-500 ease-in-out">
        <!-- (Identique au blueprint) -->
    </div>

    <header id="chat-header" class="hidden bg-white/90 backdrop-blur-md border-b p-2 md:p-3 z-10 shadow-sm shrink-0 relative">
        <!-- (Identique) -->
    </header>

    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 w-full max-w-3xl mx-auto scroll-smooth hidden"></main>

    <footer id="chat-footer" class="hidden bg-white border-t p-4 pb-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20 shrink-0 w-full max-w-3xl mx-auto">
        <!-- (Identique) -->
    </footer>

    <script>
        const API_URL = "/api";  // FIX: Préfixe pour routes
        let sessionId = localStorage.getItem('coach_sess') || 'sess_' + Date.now();
        localStorage.setItem('coach_sess', sessionId);
        let mediaRecorder; let audioChunks = []; let userCV = ""; let stream;  // FIX: Déclare stream global pour stop

        async function checkUser() {
            // (Identique, mais fetch('/api/me'))
            const res = await fetch(`${API_URL}/me`);
            // ... (reste identique)
        }
        window.onload = checkUser;

        function initPayPal() {
            // (Identique)
        }

        async function applyPromoCode() {
            // (Identique, mais fetch('/api/promo_code'))
            const res = await fetch(`${API_URL}/promo_code`, { /* ... */ });
            // ...
        }

        async function readCVFile() {
            // (Identique, mais fetch('/api/upload_cv'))
            const res = await fetch(`${API_URL}/upload_cv`, { method: 'POST', body: fd });
            // ...
        }

        // --- AVATAR & CHAT (Inchangé) ---

        async function startSession() {
            // (Identique, mais fetch(`${API_URL}/start_chat`))
            const res = await fetch(`${API_URL}/start_chat`, { /* ... */ });
            // ...
        }

        async function initMic() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });  // FIX: Capture stream
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = sendAudio;
                const btn = document.getElementById('mic-btn'); btn.disabled = false;
                const start = (e) => { e.preventDefault(); audioChunks=[]; mediaRecorder.start(); btn.classList.add('scale-110','bg-red-500'); document.getElementById('status-txt').innerText="Listening..."; };
                const stop = (e) => { e.preventDefault(); if(mediaRecorder.state==='recording') mediaRecorder.stop(); btn.classList.remove('scale-110','bg-red-500'); document.getElementById('status-txt').innerText="Processing..."; };
                btn.onmousedown = start; btn.onmouseup = stop; btn.ontouchstart = start; btn.ontouchend = stop;
            } catch (e) { alert("Microphone required"); }
        }

        async function sendAudio() {
            await new Promise(r => setTimeout(r, 200));
            if (audioChunks.length === 0) return;
            // FIX: Stop tracks pour enlever point rouge et restaurer favicon
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;  // Reset
            }
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const fd = new FormData(); fd.append('audio', blob); fd.append('session_id', sessionId);
            
            try {
                const res = await fetch(`${API_URL}/analyze`, { method: 'POST', body: fd });
                const data = await res.json();
                addMsg('user', data.transcription_user);
                setTimeout(() => {
                    addMsg('coach', data.coach_response_text, { score: data.score_pronunciation, grammar: data.feedback_grammar, tip: data.next_step_advice, better: data.better_response_example });
                    if (data.audio_base64) playAudio(data.audio_base64);
                }, 600);
            } catch (e) { addMsg('coach', "⚠️ Connection Error. Please try again."); }
            finally { document.getElementById('status-txt').innerText = "Hold to Answer"; }
        }
        
        // (Fonctions addMsg, playAudio, etc. identiques)
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/static/service-worker.js'));  <!-- FIX: Chemin -->
        }
    </script>
</body>
</html>